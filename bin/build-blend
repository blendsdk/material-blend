#!/bin/bash

echo "Building BlendJS"

DIRNAME="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
BUILD_DIR=$DIRNAME/../build
TYPINGS_DIR=$DIRNAME/../blend/typings

ES6_PROMISE_TYPING=$TYPINGS_DIR/es6-promise.d.ts
ES6_PROMISE_SCRIPT=$TYPINGS_DIR/es6-promise.js
ES6_PROMISE_TYPING_URL=https://raw.githubusercontent.com/DefinitelyTyped/DefinitelyTyped/master/es6-promise/es6-promise.d.ts
ES6_PROMISE_SCRIPT_URL=https://raw.githubusercontent.com/stefanpenner/es6-promise/master/dist/es6-promise.js

if [ -d $BUILD_DIR ]; then
    echo "Removing " $BUILD_DIR;
	rm -fR $BUILD_DIR
fi

if [ ! -f $ES6_PROMISE_TYPING ]; then
    curl -o $ES6_PROMISE_TYPING $ES6_PROMISE_TYPING_URL
    curl -o $ES6_PROMISE_SCRIPT $ES6_PROMISE_SCRIPT_URL
fi

cd $DIRNAME/../blend
# compile the themes
compass compile

#compile blend
tsc

#copy the typing for distribution
cp -fR $TYPINGS_DIR $BUILD_DIR/blend

#merge 3rd party modules to support.js
cat $BUILD_DIR/blend/typings/es6-promise.js \
    > $BUILD_DIR/blend/support.js

#merge blend.d.ts with the typings def files
cat $BUILD_DIR/blend/typings/es6-promise.d.ts \
    > $BUILD_DIR/blend/support.d.ts
